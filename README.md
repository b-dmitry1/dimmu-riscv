# dimmu-riscv
RISC-V 32/64 бит эмулятор с блоком управляения памятью MMU

## Сборка и запуск в Linux (Debian/Ubuntu)

Установите пакеты и скачайте проект:
```
    sudo apt update
    sudo apt install gcc make git
    git clone https://github.com/b-dmitry1/dimmu-riscv
    cd dimmu-riscv
```

В файле config.h выберите нужную разрядность процессора: 32 или 64 бит.
Затем соберите и запустите эмулятор:
```
    make
    ./riscv
```

## Сборка и запуск в Windows

* Вариант 1: Откройте и соберите решение в Microsoft Visual Studio 2022.
* Вариант 2: Используйте Cygwin или WSL по инструкции из раздела "Сборка и запуск в Linux".

## Сборка ядра Linux

Подготовьте необходимые пакеты для сборки ядра:
```
    sudo apt update
    sudo apt install gcc-8-riscv64-linux-gnu make bison flex ncurses-dev libssl-dev
```

Скачайте ядро нужной версии (чем новее, тем лучше):
```
    wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.8.9.tar.xz
    tar xf linux-6.8.9.tar.xz
    cd linux-6.8.9
```

В качестве шаблона используйте файл .config из поддиректории linux этого проекта.
Скопируйте файл .config в директорию linux-6.8.9.

Настройте, затем соберите ядро:
```
    make ARCH=riscv menuconfig
    make -j8 ARCH=riscv CROSS_COMPILE=riscv64-linux-gnu- Image modules
```

Ядро появится в директории arch/riscv/boot под именем Image. Его скопируйте в директорию
linux этого проекта под именем Image, если это 32 бит сборка, или Image64, если это 64 бит.

## Сборка прикладного ПО

Проще всего использовать Buildroot 2024.02 или новее.

* Скачайте Buildroot: https://buildroot.org/download.html
* Распакуйте архив и перейдите в корневую директорию Buildroot.
* Запустите конфигуратор: make menuconfig
* Выберите платформу RISC-V.
* Выберите Custom architecture.
* Выберите нужную разрядность процессора: 32 или 64 бит.
* Включите расширения (M) (A) (C), выключите (F) (V) и прочие.
* Target binary format: ELF.
* На странице Filesystem Images выберите "cpio root filesystem".
* На странице Bootloaders выключите все.
* На странице Target packages выберите нужные прикладные программы. Не выбирайте всё сразу!
В этой версии ещё нет внешнего диска, поэтому, всё должно уместиться на RAM-диске!
* Сохраните конфигурацию и выйдите из конфигуратора.
* Запустите сборку: make.
* Сборка займёт десятки минут (может потребоваться до 40 ГБ места на диске).
* В директории output/images появится файл rootfs.cpio, его скопируйте в директорию с ядром Linux
и пересоберите ядро. Только сначала посмотрите размер файла - он не должен быть больше половины
оперативной памяти виртуальной машины. Если больше, то уберите несколько программ.

В текущей версии можно создавать виртуальную машину с объёмом ОЗУ до 1 ГБ.
